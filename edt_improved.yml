name: ğŸ“ EDT L2 INFO Multi-Webhooks Dimanche-Mercredi (Version Visuelle)

on:
  schedule:
    # Dimanche Ã  18:00 Paris (pour la semaine suivante)
    - cron: "0 17 * * 0"  # Heure d'hiver: 18:00 Paris le dimanche
    #- cron: "0 16 * * 0"  # Heure d'Ã©tÃ©: 18:00 Paris le dimanche (Ã  activer en Ã©tÃ©)
    
    # Mercredi Ã  06:00 Paris (semaine en cours)
    - cron: "0 5 * * 3"  # Heure d'hiver: 06:00 Paris le mercredi
    #- cron: "0 4 * * 3"  # Heure d'Ã©tÃ©: 06:00 Paris le mercredi (Ã  activer en Ã©tÃ©)
    
  workflow_dispatch:
    inputs:
      force_send:
        description: 'Forcer l''envoi mÃªme si ce n''est pas dimanche/mercredi'
        required: false
        default: true
        type: boolean
      test_group:
        description: 'Tester un groupe spÃ©cifique'
        required: false
        type: choice
        options:
          - 'Tous les groupes'
          - 'Groupe 1'
          - 'Groupe 2' 
          - 'Groupe 3'
          - 'CM Communs'
      week_mode:
        description: 'Mode de semaine'
        required: false
        type: choice
        default: 'auto'
        options:
          - 'auto'
          - 'current'
          - 'next'

jobs:
  send-edt:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests Pillow

      - name: ğŸ• Show current time
        run: |
          echo "ğŸ• Heure UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ• Heure Paris:"
          TZ='Europe/Paris' date '+%Y-%m-%d %H:%M:%S %Z (UTC%z)'
          echo "ğŸ“… Jour de la semaine: $(date +%u) (0=Dimanche, 3=Mercredi)"

      - name: ğŸ“‹ Debug info (if manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "ğŸ”§ ExÃ©cution manuelle"
          echo "âš™ï¸ Force send: ${{ inputs.force_send }}"
          echo "ğŸ§ª Test group: ${{ inputs.test_group }}"
          echo "ğŸ“† Week mode: ${{ inputs.week_mode }}"

      - name: ğŸ“ Send EDT to Discord (Version Visuelle AmÃ©liorÃ©e)
        env:
          WEEK_MODE: ${{ inputs.week_mode }}
        run: |
          echo "ğŸš€ Lancement du bot EDT visuel amÃ©liorÃ©..."
          echo "ğŸ¨ Les EDT seront gÃ©nÃ©rÃ©s sous forme d'images style calendrier"
          echo "ğŸ“¤ Distribution dans les salons dÃ©diÃ©s:"
          echo "  - CM Communs â†’ Salon L2 Ã‰tudiant"  
          echo "  - Groupe 1 â†’ Salon Groupe 1"
          echo "  - Groupe 2 â†’ Salon Groupe 2"
          echo "  - Groupe 3 â†’ Salon Groupe 3"
          python edt_script_improved.py

      - name: ğŸ“Š Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: edt-logs-visual
          path: |
            *.log
            *.png
          retention-days: 3
          if-no-files-found: ignore
